<p>In this blog post, I&rsquo;ll walk you through how to seamlessly invoke large language models (LLMs) from Cloud Integration using the Generative AI Hub and the Orchestration Workflow API in SAP AI Core. We&rsquo;ll focus on building a <strong>GDPR-compliant</strong> automation flow that leverages <strong>data masking and pseudonymisation</strong> to ensure privacy while still delivering value from generative AI.</p>
<p>The scenario we'll explore simulates a real-world use case: when a Business Partner record is updated in SAP S/4HANA Cloud, a personalized email notification is generated by an LLM and automatically sent out via Cloud Integration.</p>
<p>Thanks to prebuilt <a href="https://help.sap.com/docs/sap-ai-core/sap-ai-core-service-guide/orchestration-8d022355037643cebf775cd3bf662cc5?locale=en-US&amp;version=CLOUD" target="_blank" rel="noopener">orchestration</a> capabilities of Generative AI Hub in SAP AI Core, such as <strong>templating</strong>, <strong>I/O filtering</strong>, and <strong>data masking</strong>, the process of generating compliant LLM responses can be achieved with just a single API call.</p>
<p><li-image width="999" height="999" alt="email-generator.png" align="inline" id="298738i91781CA0B973CB73" size="large" resized="false" sourceType="new"></li-image></p>
<p>Before diving into the implementation steps, let&rsquo;s take a closer look at the process flow behind this sample scenario.</p>
<p><strong>Process Flow (Steps)</strong></p>
<ol>
<li><strong><em>Business Partner Update in SAP S/4HANA Cloud</em></strong><br />A user creates or edits a Business Partner record in&nbsp;SAP S/4HANA Cloud.</li>
<li><strong><em>Event Triggered and Message Sent to SAP AEM</em></strong><br />The system triggers an event and sends a message to&nbsp;SAP Advanced Event Mesh (AEM).</li>
<li><strong><em>Cloud Integration iFlow Subscribes and Starts Processing</em></strong><br />The CPI iFlow&nbsp;subscribes to the AEM queue and begins processing as soon as a new message is published.</li>
<li><strong><em>Retrieve Old Payload from CAP Application</em></strong><br />The&nbsp;iFlow&nbsp;queries the&nbsp;CAP application&nbsp;to retrieve the&nbsp;previous version (old payload)&nbsp;of the Business Partner record from&nbsp;SAP HANA Cloud.</li>
<li><strong><em>Call the Orchestration Workflow API of SAP AI Core for AI-Based Email Generation</em></strong><br />With both the old and new payloads in hand, the iFlow invokes the Generative AI Hub using the Orchestration Workflow API of SAP AI Core to generate a personalized email body in HTML format. Here, a predefined orchestration pipeline applies data masking, prompt templating, and foundation model invocation to generate a compliant, personalised email body &ndash; without exposing any sensitive data.</li>
<li><strong><em>Send Email to Business Partner</em></strong><br />The&nbsp;iFlow&nbsp;sends the generated email to the Business Partner&rsquo;s email address via a standard mail adapter in Cloud Integration, completing the end-to-end notification process.</li>
</ol>
<p>As part of this blog, I will not focus on connectivity between SAP S/4HANA Cloud and SAP Advanced Event Mesh (steps 1 and 2). For a live step-by-step demonstration of the setup, please review this video: <li-emoji src="👉" class="lia-unicode-emoji" id="lia_backhand-index-pointing-right" title=":backhand_index_pointing_right:"></li-emoji>&nbsp;<a href="https://youtu.be/6hb9l0ss5ec?si=xubXNtx_7YXFm-11" target="_blank" rel="noopener">SAP Tech Bytes: Configuring SAP S/4HANA Cloud and SAP Integration Suite, advanced event mesh</a></p>
<h2>Configuring Orchestration Workflow in SAP AI Core</h2>
<p><a href="https://help.sap.com/docs/sap-ai-core/sap-ai-core-service-guide/orchestration-8d022355037643cebf775cd3bf662cc5?locale=en-US&amp;version=CLOUD" target="_blank" rel="noopener">Orchestration in SAP AI Core</a> is a managed service that enables unified access, control, and execution of generative AI models through standardized APIs, templating, and configurable AI workflow components.</p>
<p>In our scenario, we will utilize it to chain together prebuilt steps, such as data masking and foundation model invocation, to generate a personalized email body in HTML format via a single API call.</p>
<p>To access the Orchestration service in SAP AI Core, you need to set up Generative AI Hub in <a href="https://discovery-center.cloud.sap/serviceCatalog/1f756a52-8968-4ec4-92d0-f9bddf552ea3" target="_blank" rel="noopener">SAP AI Core</a> and <a href="https://discovery-center.cloud.sap/serviceCatalog/20fa1fda-1871-413d-becc-5a58884d8827" target="_blank" rel="noopener">SAP AI Launchpad</a>. Please refer to either of the following resources for setup instructions:</p>
<ul>
<li>SAP Discovery Mission: <a href="https://discovery-center.cloud.sap/protected/index.html#/missiondetail/4403/4689/?tab=overview" target="_blank" rel="noopener">Set Up SAP AI Core Generative AI Hub</a></li>
<li>SAP Developer Center Tutorial: <a href="https://developers.sap.com/group.setup-ai-core.html" target="_blank" rel="noopener">Generative AI with SAP AI Core - Setup</a></li>
</ul>
<p><li-image width="999" height="999" alt="prereq1.png" align="inline" id="298739i3731D66CDAD62166" size="large" resized="false" sourceType="new"></li-image></p>
<p>Before moving to the next step, please ensure that your orchestration configuration is deployed and is in the <em><strong>RUNNING</strong></em> status.</p>
<p><li-image width="999" height="999" alt="prereq2.png" align="inline" id="298741iF81DAFEA5A834382" size="large" resized="false" sourceType="new"></li-image></p>
<h3>Building the Orchestration Workflow</h3>
<p>Within SAP AI Launchpad, navigate to <strong>Generative AI Hub</strong> -&gt; <strong>Orchestration</strong> and click <strong>Edit Workflow </strong>to select the workflow steps you require.<br /><br /><li-image width="999" height="999" alt="prereq2.png" align="inline" id="298742i17AF74DDCCF88190" size="large" resized="false" sourceType="new"></li-image></p>
<p>For our scenario, deselect the Input Translation and Output Translation steps, as they are not needed.</p>
<p><li-image width="999" height="999" alt="aicore1.png" align="inline" id="298752i38CE9D49203FDC22" size="large" resized="false" sourceType="new"></li-image></p>
<p>In the <a href="Templating" target="_blank" rel="noopener">Templating</a> step, we define prompts that guide LLM on how to perform its task.</p>
<p>We configure two types of messages for our scenario:</p>
<ul>
<li>System Prompt</li>
<li>User Prompt</li>
</ul>
<p>The system prompt defines the overall <strong>behavior, tone, and role</strong> of the LLM. It sets global instructions that remain consistent across requests, ensuring predictable formatting and response style.</p>
<p>For our use case, the system prompt will instruct the LLM to act as a multilingual assistant that compares old and new Business Partner profiles and generates a compliant email.</p>
<li-code lang="bash">You are a multilingual assistant. Your task is to compare the old and new payloads of a Business Partner profile and generate a personalized, polite, and human-sounding email to inform the Business Partner about the changes made to their profile. If no changes are found, reply "NO_CHANGES".
Instructions:
- Detect all changes.
- Summarize them clearly.
- Keep it concise and clear.
- Don't generate the subject, only the email body.
- Format it as an HTML (NO code blocks like ```html).
- Ignore change_time change_date changes.
- Address the Business Partner by full name if available.
- Include a friendly closing.
- End the email with the following closing, exactly as shown: Best regards,&lt;br&gt;SAP BTP Adoption &amp; Consumption Center.</li-code>
<p>The user prompt provides the <strong>dynamic, task-specific input</strong> for each request. Here, we pass actual data: the <strong>old profile payload</strong>, <strong>new profile payload</strong>, and <strong>target language</strong>. These placeholders will be replaced at runtime to generate personalized content.</p>
<li-code lang="bash">Write the email in the language: {{?language_name}}
Here is the OLD profile payload: {{?old_payload}}
Here is the NEW profile payload: {{?new_payload}}</li-code>
<p><em>&nbsp;</em><li-image width="999" height="999" alt="2025-08-06_19-51-09.png" align="inline" id="298744i1D71EAF44F2B2C96" size="large" resized="false" sourceType="new"></li-image></p>
<p>In the <a href="https://help.sap.com/docs/sap-ai-core/sap-ai-core-service-guide/data-masking-d9a54d9ca54b40beacbd24e1663ec3b4?locale=en-US&amp;version=CLOUD" target="_blank" rel="noopener">Data Masking</a> step, we can anonymize or pseudonymize personally identifiable information from the input for selected entities. For our scenario, we will select the <strong>Pseudonymization</strong> option. This will substitute personally identifiable information in selected categories with a MASKED_ENTITY_ID placeholder and allow us to unmask the LLM response before returning it to the Sender.</p>
<p><li-image width="999" height="999" alt="aicore4.png" align="inline" id="298746i05827E1812528552" size="large" resized="false" sourceType="new"></li-image></p>
<p>The <a href="https://help.sap.com/docs/sap-ai-core/sap-ai-core-service-guide/enhancing-model-consumption-with-input-filtering" target="_blank" rel="noopener">Input Filtering</a> step allows you to apply content safety filters to the incoming data before invoking the foundation model.</p>
<p><li-image width="999" height="999" alt="aicore5.png" align="inline" id="298753i18CF0C0B34DF85B0" size="large" resized="false" sourceType="new"></li-image></p>
<p>In the Model Configuration step, we can select the desired model (e.g., GPT-4.1) and configure relevant parameters such as temperature, token limits, etc.</p>
<p><li-image width="999" height="999" alt="aicore6.png" align="inline" id="298749iBBA647EDEB107980" size="large" resized="false" sourceType="new"></li-image></p>
<p>Finally, the <a href="https://help.sap.com/docs/sap-ai-core/sap-ai-core-service-guide/enhancing-model-consumption-with-output-filtering" target="_blank" rel="noopener">Output Filtering</a> step enables content safety filtering on the LLM-generated response to ensure compliance and prevent undesired content.</p>
<p><li-image width="999" height="999" alt="aicore7.png" align="inline" id="298750i175484FBD4CDFD81" size="large" resized="false" sourceType="new"></li-image></p>
<p>Once the orchestration workflow is configured, you can inspect its JSON definition and download it locally. This definition will be used later when invoking the orchestration workflow via API from Cloud Integration.</p>
<p><li-image width="999" height="999" alt="aicore8.png" align="inline" id="298754iE2EFEB37A5D08970" size="large" resized="false" sourceType="new"></li-image></p>
<p>Additionally, you can test the orchestration inference directly within SAP AI Launchpad by providing sample input variables. The testing tool allows you to view and trace the LLM response and fine-tune the workflow configuration as needed.</p>
<p><li-image width="999" height="999" alt="aicore9.png" align="inline" id="298756i55B46CC7E693776E" size="large" resized="false" sourceType="new"></li-image></p>
<p>When inspecting the output payload, you can clearly trace the results of each orchestration step &ndash; such as Input Masking, Output Unmasking, Input Filtering, and Output Filtering.</p>
<p><li-image width="999" height="999" alt="aicore10.png" align="inline" id="298758i53EBA0EAD81C5D10" size="large" resized="false" sourceType="new"></li-image></p>
<p>To learn more about Orchestration in SAP AI Core, refer to the <a href="https://developers.sap.com/group.sap-ai-core-generative.html" target="_blank" rel="noopener">SAP Developer Center Tutorials: Generative AI with SAP AI Core - orchestration</a>.</p>
<h2>Configure SAP Cloud Integration Business Partner Notification iFlow</h2>
<p>Now that we have our SAP S/4HANA Cloud, SAP Advanced Event Mesh, and the Orchestration Workflow in SAP AI Core configured, we can proceed with the Cloud Integration iFlow configuration.</p>
<p>This iFlow ensures that Business Partner changes trigger compliant AI-generated email notifications, while maintaining data consistency in HANA Cloud. It leverages SAP Advanced Event Mesh, CAP, and Generative AI Hub for an automated end-to-end process.</p>
<h3>High-Level iFlow Overview</h3>
<ul>
<li>Triggered by AEM Queue&nbsp;when a new event is published.</li>
<li>Retrieves BP details from S/4HANA Cloud.</li>
<li>(<em>If event is BP update</em>)&nbsp;Fetches old BP payload&nbsp;from HANA Cloud (via CAP service).</li>
<li>Invokes the <strong>Orchestration Workflow API</strong> to compare old vs. new payloads and generate an HTML email content while ensuring that no sensitive information is passed to LLM.</li>
<li>Upserts updated BP details into SAP HANA Cloud&nbsp;via CAP service.</li>
<li>Sends an email to the Business Partner.</li>
</ul>
<h3>Step-by-Step Process Breakdown</h3>
<ol>
<li><strong>Event Trigger</strong></li>
<ul>
<li>The iFlow subscribes to the&nbsp;AEM queue&nbsp;and processes incoming events.</li>
</ul>
<li><strong>Retrieve Business Partner Details</strong></li>
<ul>
<li>An&nbsp;OData request&nbsp;is sent to&nbsp;SAP S/4HANA Cloud&nbsp;to fetch the latest BP details.</li>
<li>Key parameters (e.g., <strong>BP ID</strong><strong>, </strong><strong>BP email</strong>) are extracted and saved into the properties for further processing.</li>
</ul>
<li><strong>Map to CAP Format</strong></li>
<ul>
<li>BP details are&nbsp;transformed&nbsp;into the <strong>CAP service</strong> data model.</li>
<li>The&nbsp;new payload is stored&nbsp;in XML and JSON format for further use.</li>
</ul>
<li><strong>Conditional Logic</strong></li>
<ul>
<li><strong>BP creation</strong> &rarr; No old payload is retrieved.</li>
<li><strong>BP update</strong> &rarr; Old payload is retrieved for comparison.</li>
</ul>
<li><strong>Retrieve Old Payload from HANA Cloud (<em>BP update only</em>)</strong></li>
<ul>
<li>The iFlow calls&nbsp;the <strong>CAP service </strong>to fetch the previous BP record. Please refer to the GitHub repository <a href="https://github.com/bolodania/businesspartner_srv" target="_blank" rel="noopener">businesspartner_srv</a> for more information on the CAP service. In our scenario, the CAP service acts as an intermediary that retrieves old Business Partner data from SAP HANA Cloud, provides an OData service for data access, and enables the upsert of updated details.</li>
</ul>
<li><strong>AI-Based Email Generation</strong></li>
<ul>
<li>A subprocess calls the Orchestration Workflow API via the AI adapter to create a personalized HTML email body in a GDPR-compliant way.</li>
</ul>
<li><strong>Upsert BP Details in HANA Cloud</strong></li>
<ul>
<li>The updated BP details are upserted into SAP HANA Cloud via the CAP service.</li>
</ul>
<li><strong>Send Email</strong></li>
<ul>
<li>The iFlow sends an email using the&nbsp;Mail Adapter.</li>
</ul>
</ol>
<p><li-image width="999" height="999" alt="cpi1.png" align="inline" id="298762i0CE2AE68A87967FB" size="large" resized="false" sourceType="new"></li-image>You can find this iFlow as a ZIP archive here: <a href="https://github.com/bolodania/cpi_gen_ai_hub_blog/blob/main/AEM_GenAI_BPMailGenerator_blog.zip" target="_blank" rel="noopener">AEM_GenAI_BPMailGenerator_blog.zip</a></p>
<p>For this blog, we&rsquo;ll take a closer look at <strong>Step #6</strong>, where the <strong><a href="https://help.sap.com/docs/integration-suite/sap-integration-suite/ai-adapter" target="_blank" rel="noopener">AI Receiver Adapter</a> </strong>is used to invoke the Orchestration Workflow API configured in the previous section.</p>
<p><li-image width="999" height="999" alt="cpi2.png" align="inline" id="298765i406A07F5364686D9" size="large" resized="false" sourceType="new"></li-image></p>
<p>1) In our case, the easiest way to prepare a payload for the AI Receiver Adapter is by using a small Groovy script.</p>
<li-code lang="java">import com.sap.gateway.ip.core.customdev.util.Message
import groovy.json.JsonOutput

Message processData(Message message) {
    def map = message.getProperties()

    // Get values from properties
    def language = map.get("language")
    def oldPayload = map.get("old_payload_json")
    def newPayload = map.get("new_payload_json")

    // Build the JSON structure
    def payload = [
        orchestration_config: [
            module_configurations: [
                llm_module_config: [
                    model_name: "gpt-4.1",
                    model_params: [
                        frequency_penalty: 0,
                        presence_penalty: 0,
                        max_completion_tokens: 24576,
                        temperature: 1
                    ],
                    model_version: "2025-04-14"
                ],
                templating_module_config: [
                    template: [
                        [
                            role: "user",
                            content: [
                                [
                                    type : "text",
                                    text : "Write the email in the language: {{?language_name}}\nHere is the OLD profile payload: {{?old_payload}}\nHere is the NEW profile payload: {{?new_payload}}"
                                ]
                            ]
                        ],
                        [
                            role: "system",
                            content: [
                                [
                                    type : "text",
                                    text : """You are a multilingual assistant. Your task is to compare the old and new payloads of a Business Partner profile and generate a personalized, polite, and human-sounding email to inform the Business Partner about the changes made to their profile. If no changes are found, reply "NO_CHANGES".

Instructions:
- Detect all changes.
- Summarize them clearly.
- Keep it concise and clear.
- Don't generate the subject, only the email body.
- Format it as an HTML (NO code blocks like ```html).
- Ignore change_time change_date changes.
- Address the Business Partner by full name if available.
- Include a friendly closing.
- End the email with the following closing, exactly as shown: Best regards,&lt;br&gt;SAP BTP Adoption &amp; Consumption Center."""
                                ]
                            ]
                        ]
                    ],
                    defaults: [:]
                ],
                filtering_module_config: [
                input : [
                    filters: [
                        [
                            type: "azure_content_safety",
                            config: [
                                Hate: 2,
                                SelfHarm: 2,
                                Sexual: 2,
                                Violence: 2,
                                PromptShield: true
                            ]
                        ]
                    ]
                ],
                output: [
                    filters: [
                        [
                            type  : "azure_content_safety",
                            config: [
                                Hate: 2,
                                SelfHarm: 2,
                                Sexual: 2,
                                Violence: 2
                            ]
                        ]
                    ]
                ]
            ],
                masking_module_config: [
                    masking_providers: [
                        [
                            type: "sap_data_privacy_integration",
                            method: "pseudonymization",
                            entities: [
                                [type: "profile-credit-card-number"],
                                [type: "profile-driverlicense"],
                                [type: "profile-email"],
                                [type: "profile-sensitive-data"],
                                [type: "profile-ethnicity"],
                                [type: "profile-gender"],
                                [type: "profile-pronouns-gender"],
                                [type: "profile-iban"],
                                [type: "profile-location"],
                                [type: "profile-nationalid"],
                                [type: "profile-nationality"],
                                [type: "profile-org"],
                                [type: "profile-passport"],
                                [type: "profile-person"],
                                [type: "profile-phone"],
                                [type: "profile-political-group"],
                                [type: "profile-sapids-public"],
                                [type: "profile-religious-group"],
                                [type: "profile-sapids-internal"],
                                [type: "profile-ssn"],
                                [type: "profile-sexual-orientation"],
                                [type: "profile-trade-union"],
                                [type: "profile-address"],
                                [type: "profile-url"],
                                [type: "profile-university"],
                                [type: "profile-username-password"]
                            ],
                            mask_grounding_input: [enabled: false],
                            allowlist: []
                        ]
                    ]
                ]
            ]
        ],
        input_params: [
            language_name: language,
            old_payload: oldPayload instanceof String ? oldPayload : JsonOutput.toJson(oldPayload),
            new_payload: newPayload instanceof String ? newPayload : JsonOutput.toJson(newPayload)
        ]
    ]

    // Serialize to JSON string
    def jsonString = JsonOutput.toJson(payload)
    message.setBody(jsonString)

    return message
}
​</li-code>
<p>This script constructs the payload expected by the Orchestration API of SAP AI Core.<li-image width="999" height="999" alt="cpi3.png" align="inline" id="298764i8D609145087017D7" size="large" resized="false" sourceType="new"></li-image></p>
<p>Note that the settings within the <em>module_configurations</em> block match the configuration that you downloaded from SAP AI Launchpad.</p>
<p>2) To set up a Connection to our AI Core Orchestration deployment, we first need to configure a Security Material.<br />In your SAP BTP Cockpit and access the service key of the SAP AI Core (extended plan) service instance created earlier.</p>
<p><li-image width="999" height="999" alt="cpi4.png" align="inline" id="298766i96E718E06DB8F818" size="large" resized="false" sourceType="new"></li-image></p>
<p>Create an <strong>OAuth2 Client Credentials</strong> Security Material with:</p>
<ul>
<li>Token Service URL: <strong>url </strong>from the service key + &ldquo;/oauth/token&rdquo;</li>
<li>Client ID: <strong>clientid</strong> from the service key</li>
<li>Client Secret: <strong>clientsecret </strong>from the service key</li>
</ul>
<p><li-image width="364" height="400" alt="cpi5.png" align="inline" id="298767i7783529BF8B7EC89" size="medium" sourceType="new"></li-image></p>
<p>On the <strong>Connection</strong> tab of the AI Receiver Adapter:</p>
<ul>
<li>Set the <strong>Address</strong> to the AI_API_URL from the service key.</li>
<li>Reference the Security Material in the <strong>OAuth2 Client Credentials</strong> field.</li>
</ul>
<p><li-image width="999" height="999" alt="cpi6.png" align="inline" id="298768iD149FF2BEA8E8894" size="large" resized="false" sourceType="new"></li-image></p>
<p>On the <strong>Processing</strong> tab:</p>
<ul>
<li>Set <strong>Request Payload Source</strong> to &ldquo;Exchange Body&rdquo;.</li>
<li>Provide the <strong>Orchestration Deployment ID</strong> and <strong>AI Resource Group</strong> from SAP AI Launchpad.</li>
</ul>
<p><li-image width="999" height="999" alt="cpi8.png" align="inline" id="298771i84B4983238E49650" size="large" resized="false" sourceType="new"></li-image></p>
<p><li-image width="999" height="999" alt="cpi7.png" align="inline" id="298769i66B867762AFDDF1A" size="large" resized="false" sourceType="new"></li-image></p>
<p>3) JSON output is converted into XML for further processing.</p>
<p>4) Content Modifier step is used to extract the <strong><em>email_body</em></strong> from the Orchestration API response via the XPath expression: <strong><em>/root/orchestration_result/choices/message/content</em></strong></p>
<p><li-image width="999" height="999" alt="cpi9.png" align="inline" id="298772i757F3C22FD3B7557" size="large" resized="false" sourceType="new"></li-image></p>
<h2>Testing the Scenario End-to-End</h2>
<p>With all components configured, it&rsquo;s time to put the setup to the test.</p>
<p>📽️ <em>The video below walks through the entire process &ndash; showing the change in SAP S/4HANA Cloud, the processing inside Cloud Integration, and the final email received by the Business Partner.</em></p>
<h2>Conclusion</h2>
<p>This scenario highlights how <strong>simple and seamless it is to invoke SAP AI Core from Cloud Integration</strong> to generate compliant, human-sounding content.</p>
<p>With just a small Groovy script to prepare the payload, CPI can call an <strong>SAP AI Core Orchestration Workflow</strong> directly via the AI Receiver Adapter &ndash; without complex custom coding or middleware. All compliance safeguards, such as data masking and filtering, are handled by the orchestration workflow, ensuring that <strong>no sensitive information is ever sent to the LLM</strong>.</p>
<p>The result is an <strong>automated, end-to-end process</strong> where a Business Partner update in S/4HANA Cloud triggers an event, CPI processes it, SAP AI Core generates the compliant email body, and the recipient is informed &ndash; all with minimal configuration effort.</p>
<p>This pattern can be applied to other master data objects and backend systems, as well as to any scenario where Cloud Integration must securely generate AI-based content &mdash; making it <strong>a powerful blueprint for scaling compliant AI adoption across the enterprise.</strong></p>